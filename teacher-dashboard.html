<!DOCTYPE html>
<html>
<head>
<title>Teacher Dashboard</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDeLqOuca8tge4tOpgD7LKPIFubLew6ljQ",
  authDomain: "attendance-management-sy-da7cd.firebaseapp.com",
  databaseURL: "https://attendance-management-sy-da7cd-default-rtdb.firebaseio.com",
  projectId: "attendance-management-sy-da7cd",
  storageBucket: "attendance-management-sy-da7cd.firebasestorage.app",
  messagingSenderId: "222467905728",
  appId: "1:222467905728:web:e3a6b729c7d8b813497525",
  measurementId: "G-H6R4YFBNMB"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let rollNo = localStorage.getItem("roll_number");
document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("roll").innerText = rollNo;
    loadSubmittedStudents();
});

// Limit 2 code generations per login
let generateCount = 0;

// Generate 6-digit code
window.generateCode = function(){
    if(generateCount >= 2){
        alert("Max 2 codes per login");
        return;
    }

    let code = Math.floor(Math.random()*900000)+100000;
    document.getElementById("result").innerText = "6-Digit Code: "+code;

    set(ref(db,"currentCode"),{ code: code, timestamp: Date.now() });

    let codeBtn = document.getElementById("codeBtn");
    let qrBtn = document.getElementById("qrBtn");
    codeBtn.disabled = true;
    qrBtn.disabled = true;

    let t = 20;
    codeBtn.innerText = `Wait ${t}s`;

    let interval = setInterval(()=>{
        t--;
        codeBtn.innerText = `Wait ${t}s`;
        if(t <= 0){
            clearInterval(interval);
            codeBtn.disabled = false;
            qrBtn.disabled = false;
            codeBtn.innerText = (generateCount >= 2)?"Limit Reached":"Generate 6-Digit Code";
            document.getElementById("result").innerText = "Code Expired";
            set(ref(db,"currentCode"),{ code:null, timestamp:null });
        }
    },1000);

    generateCount++;
    if(generateCount >= 2) codeBtn.disabled = true;
}

// Load submitted students with Remove button
function loadSubmittedStudents() {
    const submittedRef = ref(db, "attendance");
    onValue(submittedRef, (snapshot) => {
        const ul = document.getElementById("submittedList");
        ul.innerHTML = "";

        if (!snapshot.exists()) {
            ul.innerHTML = "<li>No students have submitted attendance yet</li>";
            return;
        }

        let presentCount = 0;

        snapshot.forEach((childSnapshot) => {
            const studentRoll = childSnapshot.key;
            const status = childSnapshot.val();

            if(status === "Present") {
                const li = document.createElement("li");
                li.innerHTML = `${studentRoll} : ${status} <button onclick="removeStudent('${studentRoll}')">Remove</button>`;
                ul.appendChild(li);
                presentCount++;
            }
        });

        if(presentCount === 0){
            ul.innerHTML = "<li>No students have submitted attendance yet</li>";
        }
    });
}

// Remove student from attendance
window.removeStudent = function(studentRoll){
    if(confirm(`Remove ${studentRoll} from attendance?`)){
        remove(ref(db,"attendance/"+studentRoll));
    }
}

// Demo QR code generation
window.generateQRCode = function(){
    let qrData = "ATTENDANCE|"+Date.now();
    document.getElementById("result").innerText = "QR Code Generated (demo): "+qrData;
}
</script>
<style>
body{ font-family: Arial; padding:20px; background:#f4f4f4; }
button{ padding:10px 20px; margin:10px 0; border:none; background:#000DFF; color:white; cursor:pointer; border-radius:4px; font-size:16px; transition:0.3s; }
button:hover{ background:#6B73FF; }
button:disabled{ background:#aaa; cursor:not-allowed; }
#result{ margin-top:15px; font-size:18px; font-weight:bold; color:#222; }
ul{ list-style:none; padding-left:0; }
ul li{ background:#fff; margin:5px 0; padding:8px 12px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
ul li button{ margin-left:10px; padding:4px 8px; background:red; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
ul li button:hover{ background:#ff4d4d; }
</style>
</head>
<body>
<h2>Welcome Teacher</h2>
<p><b>Last Logged Roll Number:</b> <span id="roll"></span></p>

<button id="codeBtn" onclick="generateCode()">Generate 6-Digit Code</button>
<button id="qrBtn" onclick="generateQRCode()">Generate QR Code</button>

<p id="result"></p>

<h3>Students Submitted Attendance:</h3>
<ul id="submittedList">
    <li>Loading...</li>
</ul>

</body>
</html>
