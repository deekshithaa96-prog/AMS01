<!DOCTYPE html>
<html>
<head>
<title>Teacher Dashboard</title>

<!-- QR Code Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDeLqOuca8tge4tOpgD7LKPIFubLew6ljQ",
  authDomain: "attendance-management-sy-da7cd.firebaseapp.com",
  databaseURL: "https://attendance-management-sy-da7cd-default-rtdb.firebaseio.com",
  projectId: "attendance-management-sy-da7cd",
  storageBucket: "attendance-management-sy-da7cd.firebasestorage.app",
  messagingSenderId: "222467905728",
  appId: "1:222467905728:web:e3a6b729c7d8b813497525",
  measurementId: "G-H6R4YFBNMB"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Show Teacher Roll
document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById("roll").innerText = localStorage.getItem("roll_number");
    loadSubmittedStudents();
});

// Limits
let pinCount = 0;
let qrCount = 0;

// Disable both buttons for 20 sec
function disableFor20s(btn) {
    const codeBtn = document.getElementById("codeBtn");
    const qrBtn = document.getElementById("qrBtn");

    codeBtn.disabled = true;
    qrBtn.disabled = true;

    let t = 20;
    btn.innerText = `Wait ${t}s`;

    const timer = setInterval(() => {
        t--;
        btn.innerText = `Wait ${t}s`;

        if (t <= 0) {
            clearInterval(timer);

            // Re-enable
            if (pinCount < 2) codeBtn.disabled = false;
            if (qrCount < 2) qrBtn.disabled = false;

            btn.innerText = btn.id === "codeBtn"
                ? (pinCount >= 2 ? "Limit Reached" : "Generate 6-Digit Code")
                : (qrCount >= 2 ? "Limit Reached" : "Generate QR Code");

            document.getElementById("result").innerText =
                btn.id === "codeBtn" ? "Code Expired" : "QR Code Expired";

            // Expire QR visually
            if (btn.id === "qrBtn") {
                document.getElementById("qrcode").innerHTML = "";
            }
        }
    }, 1000);
}



// ⭐ Generate 6-Digit Code
window.generateCode = function() {
    if (pinCount >= 2) {
        alert("Limit reached (2 codes per login)");
        return;
    }

    const code = Math.floor(Math.random() * 900000) + 100000;
    document.getElementById("result").innerText = "6-Digit Code: " + code;

    // Store in Firebase
    set(ref(db, "currentCode"), { code: code, timestamp: Date.now() });

    disableFor20s(document.getElementById("codeBtn"));

    pinCount++;
    if (pinCount >= 2) document.getElementById("codeBtn").disabled = true;
};



// ⭐ Generate QR Code (with limit 2)
window.generateQRCode = function() {
    if (qrCount >= 2) {
        alert("QR Code limit reached (2 per login)");
        return;
    }

    // Generate QR Data
    const qrData = "QR|" + Math.floor(Math.random() * 1000000);

    // Clear old QR
    document.getElementById("qrcode").innerHTML = "";

    // Make new QR
    new QRCode(document.getElementById("qrcode"), {
        text: qrData,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });

    document.getElementById("result").innerText = "QR Code Generated!";

    disableFor20s(document.getElementById("qrBtn"));

    qrCount++;
    if (qrCount >= 2) document.getElementById("qrBtn").disabled = true;
};



// ⭐ Load Present Students
function loadSubmittedStudents() {
    const listRef = ref(db, "attendance");

    onValue(listRef, (snapshot) => {
        const ul = document.getElementById("submittedList");
        ul.innerHTML = "";

        if (!snapshot.exists()) {
            ul.innerHTML = "<li>No students submitted yet</li>";
            return;
        }

        let count = 0;

        snapshot.forEach((child) => {
            const roll = child.key;
            const status = child.val();

            if (status === "Present") {
                const li = document.createElement("li");
                li.innerHTML = `
                    ${roll} - Present
                    <button onclick="removeStudent('${roll}')">Remove</button>
                `;
                ul.appendChild(li);
                count++;
            }
        });

        if (count === 0) {
            ul.innerHTML = "<li>No students submitted yet</li>";
        }
    });
}



// ⭐ Remove student
window.removeStudent = function(roll){
    if (confirm("Remove " + roll + "?")) {
        remove(ref(db, "attendance/" + roll));
    }
};

</script>

<style>
body {
    font-family: Arial;
    background: #f4f4f4;
    padding: 20px;
}
button {
    padding: 10px 20px;
    margin: 10px 0;
    background: #000DFF;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}
button:hover { background: #6B73FF; }
button:disabled { background: #999; cursor: not-allowed; }

#qrcode { margin-top: 15px; }

#result {
    font-size: 18px;
    margin: 10px 0;
    font-weight: bold;
}

ul { padding: 0; list-style: none; }
ul li {
    background: white;
    padding: 10px;
    margin-top: 5px;
    border-radius: 5px;
    display: flex;
    justify-content: space-between;
}
ul li button {
    background: red;
    padding: 5px 10px;
    font-size: 12px;
}
</style>
</head>

<body>

<h2>Welcome Teacher</h2>
<p><b>Logged Roll No:</b> <span id="roll"></span></p>

<button id="codeBtn" onclick="generateCode()">Generate 6-Digit Code</button>
<button id="qrBtn" onclick="generateQRCode()">Generate QR Code</button>

<p id="result"></p>
<div id="qrcode"></div>

<h3>Present Students:</h3>
<ul id="submittedList">
    <li>Loading...</li>
</ul>

</body>
</html>
