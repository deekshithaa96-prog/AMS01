<!DOCTYPE html>
<html>
<head>
<title>Teacher Dashboard</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDeLqOuca8tge4tOpgD7LKPIFubLew6ljQ",
  authDomain: "attendance-management-sy-da7cd.firebaseapp.com",
  databaseURL: "https://attendance-management-sy-da7cd-default-rtdb.firebaseio.com",
  projectId: "attendance-management-sy-da7cd",
  storageBucket: "attendance-management-sy-da7cd.firebasestorage.app",
  messagingSenderId: "222467905728",
  appId: "1:222467905728:web:e3a6b729c7d8b813497525",
  measurementId: "G-H6R4YFBNMB"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let rollNo = localStorage.getItem("roll_number");
document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("roll").innerText = rollNo;
    loadSubmittedStudents();
});

let generateCount = 0;

window.generateCode = function(){
    if(generateCount>=2){
        alert("Max 2 codes per login");
        return;
    }
    let code = Math.floor(Math.random()*900000)+100000;
    document.getElementById("result").innerText = "6-Digit Code: "+code;

    set(ref(db,"currentCode"),{
        code: code,
        timestamp: Date.now()
    });

    let btn = document.getElementById("codeBtn");
    btn.disabled=true;
    let t=20;
    btn.innerText=`Wait ${t}s`;
    let interval = setInterval(()=>{
        t--;
        btn.innerText=`Wait ${t}s`;
        if(t<=0){
            clearInterval(interval);
            btn.disabled=false;
            btn.innerText=(generateCount>=2)?"Limit Reached":"Generate 6-Digit Code";
            document.getElementById("result").innerText="Code Expired";
            set(ref(db,"currentCode"),{ code:null, timestamp:null });
        }
    },1000);

    generateCount++;
    if(generateCount>=2) btn.disabled=true;
}

window.loadSubmittedStudents = function(){
    const submittedRef = ref(db,"attendance");
    onValue(submittedRef,(snapshot)=>{
        const ul = document.getElementById("submittedList");
        ul.innerHTML="";
        snapshot.forEach(child=>{
            const li=document.createElement("li");
            li.innerText = child.key + " : " + child.val();
            ul.appendChild(li);
        });
    });
}

window.generateQRCode = function(){
    let qrData = "ATTENDANCE|"+Date.now();
    document.getElementById("result").innerText = "QR Code Generated (demo): "+qrData;
}
</script>
<style>
body{ font-family: Arial; padding:20px; }
button{ padding:10px 20px; margin:10px 0; border:none; background:black; color:white; cursor:pointer; border-radius:4px
}
